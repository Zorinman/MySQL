![alt text](图片\image.png)
MySQL主从复制的核心就是二进制日志binlog

二进制日志（BINLOG）记录了所有的 DDL（数据定义语言，创建库、表）语句和 DML（数据操纵语言，增删改）语句，但不包括数据查询（SELECT、SHOW）语句。

## 主从复制作用
- 读写分离
- 数据备份
- 高可用性
  
## 主从复制原理
![alt text](图片\image-1.png)
- 二进制日志转储线程（Binglog dump thread）是一个主库线程，当从库线程连接时，主库可以将二进制日志发送给从库，当主库读取事件时，会在Binlog上加锁，读取完成后释放锁
- 从库I/O线程连接主库，向主库发送请求更新Binlog。这时从库的I/O线程就可以读取主库的二进制日志转储线程的Binlog更新部分，并且拷贝到本地的中继日志relaylog
- 从库SQL线程会读取从库中的中继日志，并且执行日志中的事件，将从库中的数据与主库保持同步

复制过程就是将binlog中的数据从主库传输到从库上，这个过程一般是异步的，即主库上执行事务操作的线程不会等待复制binlog的线程同步完成。主从复制概括为 ：在Master端开启binlog ，从库将master的binlog拷贝到它的中继日志relay log，slave端重放binlog 从而达到主从数据一致

### 主从复制步骤：

- 1.写入binlog：Master 主库在事务提交时，会把数据变更记录在二进制日志文件 Binlog 中
- 2.同步binlog：从库读取主库的二进制日志文件 Binlog ，写入到从库的中继日志 Relay Log（从库将master的binlog拷贝到它的中继日志）
- 3.回放binlog：slave重做中继日志中的事件，将改变应用到自己的数据库中
  
MySQL复制时异步且串行化的，重启后从接入点开始复制。
![alt text](图片\image-2.png)
![alt text](图片\image-6.jpg)
在完成主从复制之后，你就可以在**写数据时只写主库、读数据时只读从库**，这样即使写请求会锁表或者锁记录，也不会影响读请求的执行。

从库数量增加，从库连接上来的/O线程也比较多，**主库也要创建同样多的log dump线程来处理复制的请求，对主库资源消耗比较高，同时还受限于主库的网络带宽。**
所以在实际使用中，一个主库一般跟2~3个从库(1套数据库，1主2从1备主)，这就是一主多从的MySQL集群结构。
### 主从同步数据一致性要求
**主从同步要求**

读库、写库的数据一致
写数据必须写到写库
读数据必须到读库
**主从延迟原因**

网络正常情况下，主从延迟的主要来源是备库接收完binlog和执行完这个事务之间的时间差

从库的机器性能比主库差
从库压力大
大事务的执行
主从延迟的直接表现：从库消费中继日志的速度比主库生产binlog的速度慢

**减少主从延迟的方案**

降低多线程大事务并发的概率，优化业务逻辑
优化SQL，避免慢SQL，减少批量操作，建议写脚本以update-sleep这样的形式完成
提高从库机器配置，减少主库写binlog和从库读binlog的效率差
尽量采用短的链路，也就是主库和从库服务器的距离尽量短，提升端口带宽，减少binlog传输的网络延时
实时性要求的业务强制走主库，从库只做灾备、备份

### 数据一致性问题的解决

若操作的数据存储在同一个数据库中，那么对数据进行更新时，可对记录加写锁，这样在读取时就不会发生数据不一致的情况，但从库的作用仅为备份，未起到读写分离、分担主库读压力的作用
读写分离情况下，解决主从同步中数据不一致的问题，就是解决主从之间数据复制方式的问题。若按照数据一致性的从弱到强划分，有3种复制方式：**异步复制、半同步复制、组复制**

#### 异步复制（客户端提交COMMIT之后不需要等从库返回任何结果）
异步模式就是客户端提交COMMIT之后不需要等从库返回任何结果，而是直接将结果返回给客户端，这样做的好处是不会影响主库写的效率，但可能会存在主库宕机,而 binlog 还没有同步到从库的情况，也就是此时的主库和从库数据不一致。这时候从从库中选择一个作为新主，那么新主则可能缺少原来主服务器中已提交的事务。所以，**这种复制模式下的数据一致性是最弱的。**
![alt text](图片\image-3.png)
#### 半同步复制（待至少有一个从库返回响应后再返回给客户端）
（1）MySQL 5.5版本之后开始支持半同步复制的方式。原理是在客户端提交COMMIT之后不直接将结果返回给客户端，而是等待至少有一个从库接收到了binlog，并且写入到中继日志中，再返回给客户端。这样做的好处就是提高了数据的一致性，当然相比于异步复制来说，至少多增加了一个网络连接的延迟，降低了主库写的效率。
（2）在 MySQL 5.7版本中还增加了一个 rpl_semi_sync_master_wait_for_slave_count 参数，可以对应答的从库数量进行设置，默认为 1，也就是说只要有 1个从库进行了响应，就可以返回给客户端。如果将这个参数调大，可以提升数据一致性的强度，但也会增加主库等待从库响应的时间。
![alt text](图片\image-4.png)
#### 组复制 （多个节点组成一个复制组，读写时组里大多数节点同意才能返回给客户端）
异步复制、半同步复制都无法最终保证数据一致性问题

组复制技术，MRG（MySQL Group Replication），于MySQL在5.7.17推出的一种新的数据复制技术，基于Paxos协议的状态机复制

**MGR如何工作?**

（1）异步复制和半同步复制都无法最终保证数据的一致性问题，半同步复制是通过判断从库响应的个数来决定是否返回给客户端，虽然数据一致性相比于异步复制有提升，但仍然无法满足对数据一致性要求高的场景，比如金融领域。MGR 很好地弥补了这两种复制模式的不足。
（2）组复制技术，简称 MGR(MySQL Group Replication)。是 MySQL 在 5.7.17版本中推出的一种新的数据复制技术，这种复制技术是基于 Paxos 协议的状态机复制。
（3）**MGR是如何工作的?**
①首先我们将多个节点共同组成一个复制组，在执行读写(RW)事务 的时候，需要通过一致性协议层（Consensus 层）的同意，也就是读写事务想要进行提交，必须要经过组里"大多数人”(对应 Node 节点）的同意，大多数指的是同意的节点数量需要大于(N/2+1)，这样才可以进行提交，而不是原发起方一个说了算。而针对只读(RO)事务 则不需要经过组内同意，直接 COMMIT 即可。

②在一个复制组内有多个节点组成，它们各自维护了自己的数据副本，并且在一致性协议层实现了原子消息和全局有序消息，从而保证组内数据的一致性。
![alt text](图片\image-5.png)