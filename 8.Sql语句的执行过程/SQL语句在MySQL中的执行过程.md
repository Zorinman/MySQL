[javeguild的解释](https://javaguide.cn/database/mysql/how-sql-executed-in-mysql.html) 
注意最后总结更新语句的执行流程是错误的❌的


正确的应该是和查询一样的流程，只是后面调用存储引擎之后存储引擎的操作更加复杂

具体看[一条Update语句的执行过程是怎样的](https://zhuanlan.zhihu.com/p/639174065)



# 总结：
MySQL 的架构主要分为两层：Server 层和引擎层。

### Server 层
Server 层包括以下模块：
- **连接器**：负责管理客户端连接。
- **查询缓存**：存储查询结果的缓存（MySQL 8.0 已移除）。
- **分析器**：负责理解 SQL 语句，把它分解成小部分，检查语法是否正确，并确认提到的表和列是否存在。
- **优化器**：负责想出最好的执行方式，比如选择用哪条路来查找数据(全表扫描，索引扫描等)，如何连接多个表，如何处理子查询，以最快的方式完成任务。
- **执行器**：根据执行计划调用存储引擎执行操作。
- **日志模块（binlog）**：记录所有数据更改操作，供主从复制和数据恢复使用。

### 引擎层
引擎层是插件式的，主要包括：
- **InnoDB**：支持事务、行级锁和外键。
- **MyISAM**：不支持事务，适用于只读或轻量级应用。
- **Memory**：数据存储在内存中，速度快但数据易丢失。

### 查询语句的执行流程
1. **连接器**：建立连接，权限校验（用户登录权限）。
2. **查询缓存**（MySQL 8.0 已移除）。
3. **分析器**：负责理解 SQL 语句，把它分解成小部分，检查语法是否正确，并确认提到的表和列是否存在。
4. **优化器**：负责想出最好的执行方式，比如选择用哪条路来查找数据，如何连接多个表，如何处理子查询，以最快的方式完成任务。
5. **执行器**：权限校验（表级权限），调用存储引擎执行操作。
6. **引擎**：完成数据查询。

### 更新语句的执行流程
1. **连接器**：建立连接，权限校验（用户登录权限）。
2. **分析器**：负责理解 SQL 语句，把它分解成小部分，检查语法是否正确，并确认提到的表和列是否存在。
3. **优化器**：负责想出最好的执行方式，比如选择用哪条路来查找数据，如何连接多个表，如何处理子查询，以最快的方式完成任务。
4. **执行器**：权限校验（表级权限），调用存储引擎执行操作。
5. **引擎**：完成数据更新（获取锁 -> 修改数据页 -> redo log prepare -> binlog -> redo log commit -> 释放锁）。

> **注意**：更新语句的执行流程与查询语句类似，但存储引擎的操作更加复杂（涉及两阶段提交）。

### MySQL 权限校验区别

权限校验分为两个阶段：**连接器（用户登录权限）** 和 **执行器（表级权限）**。

#### 连接器阶段（用户登录权限）
- **时机**：连接数据库时（用户名、密码登录）。
- **检查内容**：用户身份、密码、主机等全局权限。
- **范围**：用户级（基于 `mysql.user` 表）。
- **目的**：防止未授权连接，保护数据库安全。
- **失败后果**：连接失败。

#### 执行器阶段（表级权限）
- **时机**：SQL 执行前（调用引擎前）。
- **检查内容**：对表、列、操作（如 `SELECT`、`INSERT`）的权限。
- **范围**：对象级（基于 `mysql.db` 等表）。
- **目的**：细粒度控制数据访问。
- **失败后果**：语句失败，返回权限错误。

#### 总结
- **连接器**：相当于“门卫”，决定是否允许进入数据库。
- **执行器**：相当于“房间钥匙”，决定是否允许操作具体资源。
- **关系**：前者是基础，后者是精细控制。
